flowchart TD

  %% Create Listing Flow
  subgraph CL[Create Listing]
    A[Start] --> B{Create Listing}
    B -->|Offer| O[Offer created<br>status = open]
    B -->|Request| R[Request created<br>status = open]
    O --> M1[Matchmaker finds Request matches<br>Notify both creators]
    R --> M2[Matchmaker finds Offer matches<br>Notify both creators]
  end

  %% Direct Response Flows
  subgraph DR[Direct Response]
    %% Offer -> Request response
    O --> ORa[Respond with Request]
    ORa --> ORb[Prefill Request<br>Build ResponseLink Offer→Request if respondable]
    ORb --> ORc[Create Request]
    ORc --> ORd[Mark Offer matched<br>Notify offer creator]

    %% Request -> Offer response
    R --> ROa[Respond with Offer]
    ROa --> ROb[Prefill Offer<br>Build ResponseLink Request→Offer if respondable]
    ROb --> ROc[Create Offer]
    ROc --> ROd[Mark Request matched]
  end

  %% Agreement Lifecycle
  subgraph AG[Agreement Lifecycle]
    E1[Offer + Request identified] --> A1[Create Agreement<br>status = pending]
    A1 --> N1[Notify both creators]
    A1 -->|Accept| A2[Agreement accepted]
    A2 --> C1[Close Offer & Request<br>status = closed]
    A2 --> N2[Notify status change]
    A1 -->|Reject| A3[Agreement rejected]
    A3 --> N3[Notify status change]
  end

  %% Notification Read
  subgraph NO[Notifications]
    V1[View Offer/Request/Agreement page]
    V1 --> NR[Mark related notifications as read]
  end

  %% State Summary
  subgraph ST[State Transitions]
    S1[Offer/Request: open]
    S1 -->|Agreement created or ResponseLink| S2[matched]
    S2 -->|Agreement accepted| S3[closed]
    S1 -->|manual| SF[fulfilled]
    S2 -->|manual| SF
  end

  %% Target alignment check (implicit in Agreement creation)
  A1 -. validate .- TGT{Offer and Request targets align?<br>target_type & target_id}
  TGT -- no --> A1
  TGT -- yes --> N1
