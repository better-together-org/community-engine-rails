flowchart TD
%% Accounts Flow
U[User Devise] --> P[Person]
P --> CM[Community Membership]
P --> PM[Platform Membership]
P --> AP[Agreement Participants]

subgraph REG[Registration]
R0[Visit sign-up] --> R1{Invited?}
R1 -->|Yes| R2[Prefill email]
R1 -->|No| R3[Manual email]
R2 --> R4[Accept required agreements]
R3 --> R4
R4 -->|valid| R5[Create User + Person]
R4 -->|missing| R4E[Block]
R5 --> R6[Add to host community]
R5 --> R7{Platform role?}
R7 -->|Yes| R8[Add to platform]
R7 -->|No| R9[skip]
R5 --> R10[Create AgreementParticipants]
R5 --> RC[Send confirmation email]
RC --> RSN[Sign-in public or sign-in page private]
end

subgraph INV[Invitations]
I1[Create PlatformInvitation] --> I2[Email queued with token URL]
I2 --> R0
R5 --> I3[Mark invitation accepted]
end

subgraph SESS[Sessions / Passwords]
S1[Sign-in] --> S2[Session established]
PWD1[Forgot password] --> PWD2[Email reset link] --> PWD3[Reset password]
end
