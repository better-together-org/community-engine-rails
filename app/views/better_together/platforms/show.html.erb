<% content_for :page_title do %>
  <%= @platform.name %> | <%= @platform.class.model_name.human.pluralize %>
<% end %>

<div class="container-fluid mb-3 px-0">

  <!-- Platform Header Section -->
  <div class="profile-header position-relative">
    <!-- Cover Image Section -->
    <div class="cover-image-container">
      <%= cover_image_tag(@platform) %>
    </div>

    <div class="profile-image-wrapper">
      <%= profile_image_tag(@platform) %>
    </div>
  </div>

  <!-- Profile Information Section -->
  <div class="profile-info-container container">
    <div class="row align-items-end">
      <div class="col">
        <h1 class="profile-name mt-3"><%= @platform.name %></h1>
        <p class="profile-description"><%= @platform.description.presence || t('globals.no_description') %></p>
      </div>
      <div class="col-auto">
        <%= render 'shared/resource_toolbar',
                   edit_path: policy(@platform).edit? ? edit_platform_path(@platform) : nil,
                   edit_aria_label: 'Edit Platform',
                   destroy_path: policy(@platform).destroy? ? platform_path(@platform) : nil,
                   destroy_confirm: t('platforms.confirm_delete'),
                   destroy_aria_label: 'Delete Platform' %>
      </div>
    </div>
  </div>

  <div class="container mt-4">
    <!-- Platform tabbed section -->
    <section class="card tabbed-section shadow-sm border-0">

      <div class="card-header">
        <!-- Navigation tabs -->
        <%# Initialize the active tab state with accessible attributes %>
        <%= content_tag :div, id: 'platformTabs', class: 'nav nav-tabs card-header-tabs', role: 'tablist', aria_label: 'Platform Sections' do %>
          <%= link_to t('globals.tabs.about'), '#about', class: 'nav-link active', id: 'about-tab', data: { bs_toggle: 'tab', bs_target: '#about' }, role: 'tab', aria_controls: 'about', aria_selected: 'true', tabindex: '0' %>
          <%= link_to t('globals.tabs.members'), '#members', class: 'nav-link', id: 'members-tab', data: { bs_toggle: 'tab', bs_target: '#members' }, role: 'tab', aria_controls: 'members', aria_selected: 'false', tabindex: '-1' %>
          <% if policy(BetterTogether::PlatformInvitation).index? %>
            <%= link_to t('globals.tabs.invitations'), '#invitations', class: 'nav-link', id: 'invitations-tab', data: { bs_toggle: 'tab', bs_target: '#invitations' }, role: 'tab', aria_controls: 'invitations', aria_selected: 'false', tabindex: '2' %>
          <% end %>
        <% end %>
      </div>

      <%# Content with accessible attributes and flexbox layout %>
      <div class="card-body" id="platformSections" role="tabpanel">

        <!-- Platform Details Section -->
        <section id="about" class="row collapse show" aria-labelledby="about-tab" aria-expanded="true" data-bs-parent="#platformTabs">
          <div class="col-md-12">
            <h2 class="card-title text-center mb-3">
              <%= @platform.name %>
            </h2>

            <!-- Divider Line -->
            <hr class="my-4">

            <!-- Platform Details -->
            <div class="row mb-3">
              <div class="col-md-3"><strong>Identifier:</strong></div>
              <div class="col-md-9"><%= @platform.identifier %></div>
            </div>
            <div class="row mb-3">
              <div class="col-md-3"><strong>URL:</strong></div>
              <div class="col-md-9"><%= link_to @platform.url, @platform.url, target: "_blank", rel: "noopener noreferrer" %></div>
            </div>
            <div class="row mb-3">
              <div class="col-md-3"><strong>Time Zone:</strong></div>
              <div class="col-md-9"><%= @platform.time_zone %></div>
            </div>
            <div class="row mb-3">
              <div class="col-md-3"><strong>Protected:</strong></div>
              <div class="col-md-9"><%= @platform.protected ? 'Yes' : 'No' %></div>
            </div>
            <div class="row mb-3">
              <div class="col-md-3"><strong>Requires Invitation:</strong></div>
              <div class="col-md-9"><%= @platform.requires_invitation ? 'Yes' : 'No' %></div>
            </div>
          </div>
        </section>

        <!-- Platform Members Section -->
        <section id="members" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 row-cols-xl-4 collapse" aria-labelledby="members-tab" aria-expanded="false" data-bs-parent="#platformTabs">
          <%= render partial: 'better_together/person_platform_memberships/person_platform_membership_member', collection: @platform_memberships, as: :person_platform_membership %>
        </section>

        <% if policy(BetterTogether::PlatformInvitation).index? %>
          <!-- Platform Invitations Section -->
          <section id="invitations" class="row collapse" aria-labelledby="invitations-tab" aria-expanded="false" data-bs-parent="#platformTabs">
            <%= turbo_frame_tag "platform_invitations_content", 
                                src: platform_platform_invitations_path(@platform, locale: I18n.locale),
                                loading: :lazy do %>
              <div class="d-flex justify-content-center p-4">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden"><%= t('globals.loading') %></span>
                </div>
              </div>
            <% end %>
          </section>
        <% end %>

      </div>
    </section>
  </div>
</div>

<script type="text/javascript">

  document.addEventListener("DOMContentLoaded", function() {
    // Check if URL hash is present and corresponds to a tab
    var hash = window.location.hash;
    if (hash) {
      // Activate the tab corresponding to the hash
      var selectedTab = document.querySelector(`a[data-bs-target="${hash}"]`);
      if (selectedTab) {
        new bootstrap.Tab(selectedTab).show();
      }
    }

    // Update URL hash when tab is changed
    var tabLinks = document.querySelectorAll('#platformTabs a[data-bs-toggle="tab"]');
    tabLinks.forEach(function(link) {
      link.addEventListener('shown.bs.tab', function(event) {
        window.location.hash = event.target.getAttribute('data-bs-target');
      });
    });
  });
</script>
