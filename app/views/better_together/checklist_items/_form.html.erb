<%# app/views/better_together/checklist_items/_form.html.erb %>
<%# Safely resolve optional locals to avoid NameError when partial is rendered without all locals %>
<% current = (local_assigns[:form_object] || local_assigns[:checklist_item] || local_assigns[:new_checklist_item]) %>
<%= turbo_frame_tag (current ? "#{dom_id(current)}_frame" : 'new_checklist_item') do %>
  <%= form_with(model: current || local_assigns[:new_checklist_item], url: form_url || request.path, local: false) do |f| %>
    <div class="mb-2">
      <%= f.label :label, t('better_together.checklist_items.label', default: 'Label') %>
      <%= f.text_field :label, class: 'form-control' %>
    </div>

    <div class="mb-2">
      <%= f.label :description, t('better_together.checklist_items.description', default: 'Description') %>
      <%= f.rich_text_area :description, class: 'form-control', rows: 3 %>
    </div>

    <div class="mb-2">
      <%= f.label :privacy, t('better_together.checklist_items.privacy', default: 'Privacy') %>
      <%= privacy_field(form: f, klass: BetterTogether::ChecklistItem) %>
    </div>

    <div class="mb-2">
      <%= f.label :parent_id, t('better_together.checklist_items.parent', default: 'Parent item (optional)') %>
  <%# reuse the safely-resolved current variable from above (already set) %>
      <% all_items = current.checklist.checklist_items.with_translations.order(:position) %>
      <% # Exclude self and descendants to avoid cycles %>
      <% excluded_ids = [current.id].compact + current.children.map(&:id) %>
      <% allowed_parents = all_items.reject do |it|
           excluded_ids.include?(it.id) || it.depth >= BetterTogether::ChecklistItem::MAX_NESTING_DEPTH
         end %>

      <%# Build nested option titles using depth (e.g. "â€” Child label") %>
  <% options = allowed_parents.map { |it| [checklist_item_option_title(it), it.id] } %>

      <%= f.select :parent_id,
                   options_for_select(options, (current.parent_id if current.respond_to?(:parent_id))),
                   { include_blank: true },
                   { class: 'form-select' + (current.errors[:parent_id].any? ? ' is-invalid' : ''), data: { controller: "better_together--slim-select" } } %>
    </div>

    <div class="d-flex justify-content-end">
  <%= f.submit t('globals.save', default: 'Save'), class: 'btn btn-primary btn-sm' %>
  <%= button_tag t('globals.cancel', default: 'Cancel'), type: 'submit', name: 'cancel', value: 'true', class: 'btn btn-secondary btn-sm ms-2' %>
    </div>
  <% end %>
<% end %>
