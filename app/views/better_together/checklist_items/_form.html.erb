<%# app/views/better_together/checklist_items/_form.html.erb %>
<%= turbo_frame_tag dom_id(form_object || checklist_item || new_checklist_item) do %>
  <%= form_with(model: form_object || checklist_item || new_checklist_item, url: form_url || request.path, local: false) do |f| %>
    <div class="mb-2">
      <%= f.label :label, t('better_together.checklist_items.label', default: 'Label') %>
      <%= f.text_field :label, class: 'form-control' %>
    </div>

    <div class="mb-2">
      <%= f.label :description, t('better_together.checklist_items.description', default: 'Description') %>
      <%= f.text_area :description, class: 'form-control', rows: 3 %>
    </div>

    <div class="mb-2">
      <%= f.label :parent_id, t('better_together.checklist_items.parent', default: 'Parent item (optional)') %>
      <% current = (form_object || checklist_item || new_checklist_item) %>
      <% all_items = current.checklist.checklist_items.with_translations.order(:position) %>
      <% # Exclude self and descendants to avoid cycles %>
      <% excluded_ids = [current.id].compact + current.children.map(&:id) %>
      <% allowed_parents = all_items.reject do |it|
           excluded_ids.include?(it.id) || it.depth >= BetterTogether::ChecklistItem::MAX_NESTING_DEPTH
         end %>

      <%= f.collection_select :parent_id,
                              allowed_parents,
                              :id,
                              :label,
                              { include_blank: true },
                              { class: 'form-select' } %>
    </div>

    <div class="d-flex justify-content-end">
      <%= f.submit t('globals.save', default: 'Save'), class: 'btn btn-primary btn-sm' %>
    </div>
  <% end %>
<% end %>
