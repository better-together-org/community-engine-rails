<%= form_with(model: event, class: 'form', multipart: true, id: dom_id(event, 'form'), local: true, data: { controller: "better_together--form-validation better_together--tabs" }) do |form| %>
  <%= form.fields_for(:event_hosts) do |event_host_fields| %>
    <%= event_host_fields.hidden_field :host_id %>
    <%= event_host_fields.hidden_field :host_type %>
  <% end %>

  <%= form.hidden_field :creator_id, value: current_person&.id unless form.object.creator_id %>

  <% content_for :resource_toolbar do %>
    <div class="btn-toolbar mb-3" role="toolbar" aria-label="<%= t('helpers.toolbar.aria_label') %>">
      <div class="btn-group me-2" role="group">
        <%= link_to t('better_together.events.back_to_events'), events_path, class: 'btn btn-secondary' %>
      </div>
      <div class="btn-group me-2" role="group">
        <%= form.submit t('better_together.events.save_event'), class: 'btn btn-primary' %>
      </div>
      <% if event.persisted? %>
        <div class="btn-group me-2" role="group">
          <%= link_to t('better_together.events.view_event'), event, class: 'btn btn-info' %>
        </div>
      <% end %>
    </div>
  <% end %>

  <%= yield :resource_toolbar %>

  <%= turbo_frame_tag 'form_errors' %>

  <div class="row">
    <!-- Vertical Pills Navigation -->
    <div class="col-md-3">
      <div class="nav flex-column nav-pills" id="event-form-tabs" role="tablist" aria-orientation="vertical">
        <button class="nav-link active" id="event-details-tab" data-bs-toggle="pill" data-bs-target="#event-details" type="button" role="tab" aria-controls="event-details" aria-selected="true" data-better_together--tabs-target="tab">
          <%= t('better_together.events.tabs.details') %>
        </button>
        <button class="nav-link" id="event-time-and-place-tab" data-bs-toggle="pill" data-bs-target="#event-time-and-place" type="button" role="tab" aria-controls="event-time-and-place" aria-selected="false" data-better_together--tabs-target="tab">
          <%= t('better_together.events.tabs.time-and-place') %>
        </button>
        <button class="nav-link" id="event-images-tab" data-bs-toggle="pill" data-bs-target="#event-images" type="button" role="tab" aria-controls="event-images" aria-selected="false" data-better_together--tabs-target="tab">
          <%= t('better_together.events.tabs.images') %>
        </button>
      </div>
    </div>

    <!-- Tab Content -->
    <div class="col-md-9 tab-content" id="event-form-tabs-content">
      <!-- Event Details Tab -->
      <div class="nav-tab-pane tab-pane fade show active" id="event-details" role="tabpanel" aria-labelledby="event-details-tab">
        <div class="row mb-3 row-cols-1 row-cols-sm-2">
          <!-- Translatable Name Field -->
          <div class="col mb-3 pb-3 border-bottom">
            <%= render partial: 'better_together/shared/translated_string_field', locals: { model: event, form: form, attribute: 'name' } %>
            <small class="form-text text-muted mt-2"><%= t('better_together.events.hints.name') %></small>
          </div>

          <!-- Translatable Slug Field -->
          <div class="col mb-3 pb-3 border-bottom">
            <%= render partial: 'better_together/shared/translated_string_field', locals: { model: event, form: form, attribute: 'slug' } %>
            <small class="form-text text-muted mt-2"><%= t('better_together.events.hints.slug') %></small>
          </div>

          <!-- Privacy Field -->
          <div class="col mb-3 pb-3 border-bottom">
            <%= form.label :privacy, t('better_together.events.labels.privacy') %>
            <%= privacy_field(form:, klass: event.class) %>
            <% if event.errors[:privacy].any? %>
              <div class="invalid-feedback">
                <%= event.errors[:privacy].join(", ") %>
              </div>
            <% end %>
          </div>

          <div class="col mb-3 pb-3 border-bottom">
            <%= required_label form, :categories %>
            <%= form.select :category_ids,
              options_from_collection_for_select(
                resource_class.category_klass.positioned.all.includes(:string_translations),
                :id, :name, event.category_ids
              ),
              { include_blank: true, multiple: true },
              class: 'form-select', data: { controller: 'better_together--slim_select' } %>
            <small class="form-text text-muted"><%= t('hints.categories.select_multiple') %></small>
          </div>

          <div class="col mb-3 pb-3 border-bottom">
            <%= required_label form, :registration_url, class: "form-label" %>
            <%= form.url_field :registration_url, class: 'form-control' %>
          </div>
        </div>

        <div class="row">
          <!-- Translatable Description Field -->
          <div class="col mb-3 pb-3 border-bottom">
            <%= render partial: 'better_together/shared/translated_rich_text_field', locals: { model: event, form: form, attribute: 'description' } %>
            <small class="form-text text-muted mt-2"><%= t('better_together.events.hints.description') %></small>
          </div>
        </div>
      </div>

      <!-- Event Schedule Tab -->
      <div class="nav-tab-pane tab-pane fade" id="event-time-and-place" role="tabpanel" aria-labelledby="event-time-and-place-tab">
        <div class="mb-3">
          <%= render 'event_datetime_fields', form: form, event: event %>

            <!-- Start Location Field -->
            <div class="col-12 mb-3 pb-3 border-bottom">
              <%# form.label :location, t('better_together.events.labels.location') %>

              <div class="location-fields" data-controller="better_together--location-selector">
                <%= form.fields_for :location, (event.location || event.build_location) do |location_form| %>
                  <%= location_form.hidden_field :locatable_id  %>
                  <%= location_form.hidden_field :locatable_type  %>

                  <!-- Location Type Selection -->
                  <div class="mb-3">
                    <label class="form-label"><%= t('better_together.events.labels.location_type') %></label>
                    <div class="btn-group w-100" role="group" data-better_together--location-selector-target="typeSelector">
                      <input type="radio" class="btn-check" name="location_type_selector" id="simple_location" value="simple" 
                             <%= 'checked' if event.location&.simple_location? %>
                             data-action="change->better_together--location-selector#toggleLocationType">
                      <label class="btn btn-outline-primary" for="simple_location">
                        <%= t('better_together.events.location_types.simple') %>
                      </label>

                      <%# Temporarily hide Address & Building options while debugging the location selector specs %>
                      <% if false %>
                       
                      <input type="radio" class="btn-check" name="location_type_selector" id="address_location" value="address"
                             <%= 'checked' if event.location&.address? %>
                             data-action="change->better_together--location-selector#toggleLocationType">
                      <label class="btn btn-outline-primary" for="address_location">
                        <%= t('better_together.events.location_types.address') %>
                      </label>

                      <input type="radio" class="btn-check" name="location_type_selector" id="building_location" value="building"
                             <%= 'checked' if event.location&.building? %>
                             data-action="change->better_together--location-selector#toggleLocationType">
                      <label class="btn btn-outline-primary" for="building_location">
                        <%= t('better_together.events.location_types.building') %>
                      </label>

                      <% end %>
                    </div>
                  </div>

                  <!-- Simple Location Name -->
                  <div class="mb-3" data-better_together--location-selector-target="simpleLocation" 
                       style="<%= 'display: none;' unless event.location&.simple_location? %>">
                    <%= location_form.label :name, t('better_together.events.labels.location_name'), class: 'form-label' %>
                    <%= location_form.text_field :name, class: 'form-control', 
                        placeholder: t('better_together.events.placeholders.location_name') %>
                    <small class="form-text text-muted"><%= t('better_together.events.hints.location_name') %></small>
                  </div>

                  <!-- Address Selection (temporarily disabled) -->
                  <% if false %>
                  <div class="mb-3" data-better_together--location-selector-target="addressLocation"
                       style="<%= 'display: none;' unless event.location&.address? %>">
                    <%= location_form.label :location_id, t('better_together.events.labels.select_address'), class: 'form-label' %>
                    <div class="d-flex gap-2 align-items-start">
                      <%= location_form.collection_select :location_id,
                          BetterTogether::Geography::LocatableLocation.available_addresses_for(current_person),
                          :id, :to_formatted_s,
                          { prompt: t('better_together.events.prompts.select_address') },
                          { class: 'form-select', 
                            data: { action: 'change->better_together--location-selector#updateAddressType', better_together__location_selector_target: 'locationSelect' } } %>

                      <% if policy(BetterTogether::Address).create? %>
                        <!-- Button to create a new address inline -->
                        <%= link_to '#', class: 'btn btn-outline-secondary btn-sm mt-1',
                            data: { action: 'click->better_together--location-selector#showNewAddress' } do %>
                          <i class="fa-solid fa-plus"></i>
                          <span class="visually-hidden"><%= t('better_together.events.actions.create_new_address') %></span>
                          <span aria-hidden="true"><%= t('better_together.events.actions.create_new_short', default: 'New') %></span>
                        <% end %>
                      <% else %>
                        <button type="button" class="btn btn-outline-secondary btn-sm mt-1" disabled title="<%= t('better_together.events.hints.create_permission_denied') %>">
                          <i class="fa-solid fa-plus"></i>
                          <span aria-hidden="true"><%= t('better_together.events.actions.create_new_short', default: 'New') %></span>
                        </button>
                      <% end %>
                    </div>
                    <%= location_form.hidden_field :location_type, value: 'BetterTogether::Address',
                        data: { better_together__location_selector_target: 'addressTypeField' } %>

                    <small class="form-text text-muted"><%= t('better_together.events.hints.select_address') %></small>

                    <!-- Inline new address fields (hidden until user clicks 'New') -->
                    <div data-better_together--location-selector-target="newAddress" style="display: none; margin-top: 0.75rem;">
                      <%# Build nested attributes for a new Address under the locatable location %>
                      <%= location_form.fields_for :location, BetterTogether::Address.new do |new_addr_form| %>
                        <%= render 'better_together/addresses/address_fields', form: new_addr_form %>
                      <% end %>
                    </div>
                  </div>
                  <% end %>

                  <!-- Building Selection (temporarily disabled) -->
                  <% if false %>
                  <div class="mb-3" data-better_together--location-selector-target="buildingLocation"
                       style="<%= 'display: none;' unless event.location&.building? %>">
                    <%= location_form.label :location_id, t('better_together.events.labels.select_building'), class: 'form-label' %>
                    <div class="d-flex gap-2 align-items-start">
                      <%= location_form.collection_select :location_id,
                          BetterTogether::Geography::LocatableLocation.available_buildings_for(current_person),
                          :id, :name,
                          { prompt: t('better_together.events.prompts.select_building') },
                          { class: 'form-select',
                            data: { action: 'change->better_together--location-selector#updateBuildingType', better_together__location_selector_target: 'buildingSelect' } } %>

                      <% if policy(BetterTogether::Infrastructure::Building).create? %>
                        <!-- Button to create a new building inline -->
                        <%= link_to '#', class: 'btn btn-outline-secondary btn-sm mt-1',
                            data: { action: 'click->better_together--location-selector#showNewBuilding' } do %>
                          <i class="fa-solid fa-plus"></i>
                          <span class="visually-hidden"><%= t('better_together.events.actions.create_new_building') %></span>
                          <span aria-hidden="true"><%= t('better_together.events.actions.create_new_short', default: 'New') %></span>
                        <% end %>
                      <% else %>
                        <button type="button" class="btn btn-outline-secondary btn-sm mt-1" disabled title="<%= t('better_together.events.hints.create_permission_denied') %>">
                          <i class="fa-solid fa-plus"></i>
                          <span aria-hidden="true"><%= t('better_together.events.actions.create_new_short', default: 'New') %></span>
                        </button>
                      <% end %>
                    </div>

                    <%= location_form.hidden_field :location_type, value: 'BetterTogether::Infrastructure::Building',
                        data: { better_together__location_selector_target: 'buildingTypeField' } %>

                    <small class="form-text text-muted"><%= t('better_together.events.hints.select_building') %></small>

                    <!-- Inline new building fields (hidden until user clicks 'New') -->
                    <div data-better_together--location-selector-target="newBuilding" style="display: none; margin-top: 0.75rem;">
                      <%= location_form.fields_for :location, BetterTogether::Infrastructure::Building.new do |new_bld_form| %>
                        <%= render 'better_together/infrastructure/buildings/fields', form: new_bld_form %>
                      <% end %>
                    </div>
                  </div>
                  <% end %>
                <% end %>
              </div>
              <% if event.errors[:location].any? %>
                <div class="invalid-feedback">
                  <%= event.errors[:location].join(", ") %>
                </div>
              <% end %>
              <small class="form-text text-muted mt-2"><%= t('better_together.events.hints.location') %></small>
            </div>
          </div>
        </div>
      </div>

      <!-- Event Images Tab -->
      <div class="nav-tab-pane tab-pane fade" id="event-images" role="tabpanel" aria-labelledby="event-images-tab">
        <div class="mb-3">
          <div id="event-cover-image-fields" class="mb-3" data-controller="better_together--image-preview"
            data-image-preview-clear-value="<%= t('globals.clear') %>"
            data-image-preview-undo-clear-value="<%= t('globals.undo_clear') %>">
            <%= label_tag do %>
              <%= event.class.human_attribute_name(:cover_image) %>
              <% if event.cover_image.attached? %>
                : <%= event.cover_image.filename %>
              <% end %>
            <% end %>

            <div class="input-group">
              <%= form.file_field :cover_image, accept: acceptable_image_file_types, "data-better_together--image-preview-target" => 'input', data: { 'action' => "better_together--image-preview#preview" }, class: "form-control" %>
              <%= form.hidden_field :remove_cover_image, value: '0', "data-better_together--image-preview-target" => "deleteField" %>
              <%= button_tag t('globals.clear'), { type: 'button', class: 'btn btn-secondary', "data-better_together--image-preview-target" => "deleteButton", data: { 'action' => "better_together--image-preview#toggleDelete", 'clear-value' => t('globals.clear'), 'undo-clear-value' => t('globals.undo_clear'), 'no-image-value' => t('globals.no_image') } } %>
            </div>

            <small class="form-text text-muted"><%= t('helpers.hint.event.cover_image') %></small>

            <div class="my-3 text-center preview-target" data-better_together--image-preview-target="preview" data-image-classes="cover-image" data-url="<%= event.cover_image.url if event.cover_image.attached? %>">
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <%= yield :resource_toolbar %>
<% end %>
