<% invitation = BetterTogether::EventInvitation.new(invitable: @event, inviter: current_person) %>
<%# Only show the invitation UI to users permitted to manage the platform. This prevents non-platform-manager users from inviting others while the feature is being finished. %>
<% if policy(invitation).create? %>
  <div class="card my-3">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span><%= t('better_together.invitations.event_panel.title', default: 'Invite People') %></span>
    </div>
    <div class="card-body">
      <div id="form_errors"></div>
      <%= form_with url: better_together.event_invitations_path(event_id: @event.slug), method: :post, data: { turbo: true } do |f| %>
        <div class="row g-2 align-items-end">
          <div class="col-sm-6">
            <%= f.label :invitee_email, t('better_together.invitations.invitee_email', default: 'Email'), class: 'form-label' %>
            <%= f.text_field :invitee_email, name: 'invitation[invitee_email]', class: 'form-control', required: true %>
          </div>
          <div class="col-sm-3">
            <%= f.label :locale, t('globals.locale', default: 'Locale'), class: 'form-label' %>
            <%= f.select :locale, I18n.available_locales.map{ |l| [l, l] }, {}, name: 'invitation[locale]', class: 'form-select' %>
          </div>
          <div class="col-sm-3">
            <%= f.submit t('better_together.invitations.send_invite', default: 'Send Invitation'), class: 'btn btn-primary w-100' %>
          </div>
        </div>
      <% end %>

      <% pending = BetterTogether::EventInvitation.where(invitable: @event, status: 'pending') %>
      <% if pending.any? %>
        <hr/>
        <h6 class="mb-2"><%= t('better_together.invitations.pending', default: 'Pending Invitations') %></h6>
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th><%= t('globals.email', default: 'Email') %></th>
                <th><%= t('globals.sent', default: 'Sent') %></th>
                <th></th>
              </tr>
            </thead>
            <tbody id="event_invitations_table_body">
              <% pending.each do |pi| %>
                <tr id="<%= dom_id(pi) %>">
                  <td><%= pi[:invitee_email] %></td>
                  <td><%= l(pi.last_sent, format: :short) if pi.last_sent %></td>
                  <td class="text-end">
                    <% if policy(pi).resend? %>
                      <%= button_to t('globals.resend', default: 'Resend'), better_together.resend_event_invitation_path(@event, pi), method: :put, class: 'btn btn-outline-secondary btn-sm me-2' %>
                    <% end %>
                    <% if policy(pi).destroy? %>
                      <%= button_to t('globals.remove', default: 'Remove'), better_together.event_invitation_path(@event, pi), method: :delete, class: 'btn btn-outline-danger btn-sm' %>
                    <% end %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% end %>
    </div>
  </div>
<% end %>

