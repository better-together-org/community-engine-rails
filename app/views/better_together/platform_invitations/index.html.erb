<!-- app/views/better_together/platform_invitations/index.html.erb -->

<%= turbo_frame_tag "platform_invitations_content" do %>
  <div id="platform-invitations-actions" data-controller="better_together--platform-invitations" class="row mb-3">
    <div class="col">
      <div class="btn-toolbar" role="toolbar" aria-label="Toolbar with button groups">
        <div class="btn-group" role="group" aria-label="First group">
          <button type="button" class="btn btn-outline-primary" data-action="click->better_together--platform-invitations#openNewInvitationModal">
            <i class="fas fa-envelope"></i> <%= t('better_together.platform_invitations.new_invitation') %>
          </button>
        </div>
      </div>

      <!-- New Invitation Modal -->
      <div class="modal fade" id="newInvitationModal" tabindex="-1" aria-labelledby="newInvitationModalLabel" data-better_together--platform-invitations-target="newInvitationModal" data-action="turbo:submit-end->better_together--platform-invitations#handleInviteSuccess">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="newInvitationModalLabel"><%= t('better_together.platform_invitations.create_new_invitation') %></h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <%= form_with model: [ @platform, ::BetterTogether::PlatformInvitation.new ], data: { turbo: false, turbo_frame: "modal_form", controller: 'better_together--form-validation', action: 'submit->better_together--platform-invitations#submitForm' }, local: false do |form| %>
                <!-- Rendering error messages here -->
                <%= turbo_frame_tag 'invitation_form_errors' %>

                <%= hidden_field_tag "platform_invitation[community_role_id]", @default_community_role&.id %>

                <div data-controller="better_together--dependent-fields">
                  <div class="row">
                    <div class="col col-md-6 mb-3">
                      <%= form.label :locale, "Select language *", class: "form-label" %>
                      <%= language_select_field(form:) %>
                    </div>
                    <div class="col col-md-6 mb-3">
                      <%= required_label(form, :type, class: "form-label") %>
                      <%= type_select_field(form: form, model_class: ::BetterTogether::PlatformInvitation, include_model_class: true, include_blank: false, required: false, 'data-better_together--dependent-fields-target' => "controlField") %>
                      <small class="form-text text-muted"><%= t('hints.resource.type') %></small>
                    </div>
                  </div>

                  <div class="row">
                    <div class="col col-md-6 mb-3 pb-3 border-bottom">
                      <%= form.label :valid_from %>
                      <%= form.datetime_field :valid_from, include_seconds: false, class: "form-control", value: Time.zone.now, required: true %>
                    </div>
                    <div class="col col-md-6 mb-3 pb-3 border-bottom">
                      <%= form.label :valid_until %>
                      <%= form.datetime_field :valid_until, include_seconds: false, class: "form-control" %>
                    </div>
                  </div>

                  <div class="border-bottom mb-3 pb-3">
                    <%= render partial: 'better_together/content/blocks/fields/shared/range_slider_field',
                    locals: { block: form.object, scope: 'platform_invitation', attribute: :session_duration_mins, value: form.object.session_duration_mins, min: 0, max: 60, step: 5, representation_format: "percentage" } %>
                  </div>

                  <div class="hidden-field" data-better_together--dependent-fields-target="dependentField" data-show-unless-value="BetterTogether::GuestAccess">
                    <div class="row mt-3">
                      <div class="mb-3 pb-3 col-md-6 border-bottom">
                        <%= form.label :community_role_id, "Select Community Role *", class: "form-label" %>
                        <%= form.collection_select :community_role_id, @community_roles, :id, :name, { prompt: "Select a platform community role" }, { class: "form-select", required: true, data: { controller: 'better_together--slim-select' } } %>
                      </div>

                      <div class="mb-3 pb-3 col-md-6 border-bottom">
                        <%= form.label :platform_role_id, "Select Platform Role", class: "form-label" %>
                        <%= form.collection_select :platform_role_id, @platform_roles, :id, :name, { prompt: "Select a platform role" }, { class: "form-select", title: 'Platform Role', data: { controller: 'better_together--slim-select' } } %>
                      </div>
                    </div>
                  </div>

                  <%= render partial: 'better_together/platform_invitations/extra_invitation_fields', locals: { form: } %>

                  <div class="mb-3">
                    <%= required_label(form, :invitee_email, class: "form-label") %>
                    <%= form.text_field :invitee_email, class: "form-control", required: false %>
                  </div>

                  <div class="mb-3">
                    <%= form.label :greeting, "Enter a greeting", class: "form-label" %>
                    <%= form.rich_text_area :greeting, class: 'form-control', rows: 1, placeholder: t('better_together.platform_invitation.greeting-placeholder') %>
                  </div>
                </div>

                <div class="mb-3">
                  <%= form.submit "Invite", class: "btn btn-primary" %>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col table-responsive">
      <%= turbo_frame_tag 'platform_invitations_table' do %>
        <%= form_with url: platform_platform_invitations_path(@platform), method: :get, local: true, 
            data: { 
              turbo_frame: "platform_invitations_content",
              controller: 'better-together--auto-submit',
              auto_submit_delay_value: 500
            } do |form| %>
          <table class="platform-invitations table table-striped table-hover">
          <thead>
            <tr>
              <th scope="col"><%= t('globals.actions') %></th>
              <th scope="col"><%= BetterTogether::PlatformInvitation.human_attribute_name(:type) %></th>
              <th scope="col"><%= BetterTogether::PlatformInvitation.human_attribute_name(:session_duration_mins) %></th>
              <th scope="col"><%= sortable_column_header_for_invitations('invitee_email', BetterTogether::PlatformInvitation.human_attribute_name(:invitee_email), @platform) %></th>
              <th scope="col"><%= BetterTogether::PlatformInvitation.human_attribute_name(:invitee) %></th>
              <th scope="col"><%= BetterTogether::PlatformInvitation.human_attribute_name(:inviter) %></th>
              <th scope="col"><%= sortable_column_header_for_invitations('status', BetterTogether::PlatformInvitation.human_attribute_name(:status), @platform) %></th>
              <th scope="col"><%= sortable_column_header_for_invitations('valid_from', BetterTogether::PlatformInvitation.human_attribute_name(:valid_from), @platform) %></th>
              <th scope="col"><%= sortable_column_header_for_invitations('valid_until', BetterTogether::PlatformInvitation.human_attribute_name(:valid_until), @platform) %></th>
              <th scope="col"><%= sortable_column_header_for_invitations('accepted_at', BetterTogether::PlatformInvitation.human_attribute_name(:accepted_at), @platform) %></th>
              <th scope="col"><%= sortable_column_header_for_invitations('last_sent', BetterTogether::PlatformInvitation.human_attribute_name(:last_sent), @platform) %></th>
              <th scope="col"><%= sortable_column_header_for_invitations('created_at', BetterTogether::PlatformInvitation.human_attribute_name(:created_at), @platform) %></th>
            </tr>
            <tr>
              <!-- Actions column - no filter -->
              <th></th>
              <!-- Type column - no filter -->
              <th></th>
              <!-- Session Duration column - no filter -->
              <th></th>
              <!-- Email filter -->
              <th>
                <div class="input-group input-group-sm">
                  <%= form.text_field 'filters[search]', 
                      value: current_search_filter_for_invitations,
                      class: 'form-control form-control-sm',
                      placeholder: t('better_together.platform_invitations.search_by_email'),
                      'aria-label' => t('better_together.platform_invitations.search_by_email') %>
                  <% if current_search_filter_for_invitations.present? %>
                    <%= link_to platform_platform_invitations_path(@platform, 
                          filters: { status: current_status_filter_for_invitations }.compact,
                          sort_by: params[:sort_by],
                          sort_direction: params[:sort_direction],
                          page: params[:page]
                        ), class: 'input-group-text btn btn-outline-secondary btn-sm', 
                        title: t('globals.clear_filter'),
                        'aria-label' => t('globals.clear_filter'),
                        data: { turbo_frame: "platform_invitations_content" } do %>
                      <i class="fas fa-times" aria-hidden="true"></i>
                    <% end %>
                  <% end %>
                </div>
              </th>
              <!-- Invitee column - no filter -->
              <th></th>
              <!-- Inviter column - no filter -->
              <th></th>
              <!-- Status filter -->
              <th>
                <div class="input-group input-group-sm">
                  <%= form.select 'filters[status]', 
                      options_for_select([
                        [t('globals.all'), ''],
                        [t('better_together.platform_invitations.status.pending'), 'pending'],
                        [t('better_together.platform_invitations.status.accepted'), 'accepted'],
                        [t('better_together.platform_invitations.status.expired'), 'expired']
                      ], current_status_filter_for_invitations), 
                      {}, { 
                        class: "form-select form-select-sm",
                        'aria-label' => t('better_together.platform_invitations.filter_by_status'),
                        data: { action: 'change->better-together--auto-submit#submit' }
                      } %>
                  <% if current_status_filter_for_invitations.present? %>
                    <%= link_to platform_platform_invitations_path(@platform, 
                          filters: { search: current_search_filter_for_invitations }.compact,
                          sort_by: params[:sort_by],
                          sort_direction: params[:sort_direction],
                          page: params[:page]
                        ), class: 'input-group-text btn btn-outline-secondary btn-sm', 
                        title: t('globals.clear_filter'),
                        'aria-label' => t('globals.clear_filter'),
                        data: { turbo_frame: "platform_invitations_content" } do %>
                      <i class="fas fa-times" aria-hidden="true"></i>
                    <% end %>
                  <% end %>
                </div>
              </th>
              <!-- Valid from column - datetime filter -->
              <th>
                <div class="d-flex flex-column gap-1">
                  <div class="input-group input-group-sm">
                    <%= form.date_field 'filters[valid_from][from]', 
                        value: current_valid_from_filter_for_invitations[:from],
                        class: 'form-control form-control-sm',
                        placeholder: t('globals.from'),
                        'aria-label' => "#{BetterTogether::PlatformInvitation.human_attribute_name(:valid_from)} #{t('globals.from')}" %>
                  </div>
                  <div class="input-group input-group-sm">
                    <%= form.date_field 'filters[valid_from][to]', 
                        value: current_valid_from_filter_for_invitations[:to],
                        class: 'form-control form-control-sm',
                        placeholder: t('globals.to'),
                        'aria-label' => "#{BetterTogether::PlatformInvitation.human_attribute_name(:valid_from)} #{t('globals.to')}" %>
                  </div>
                  <% if current_valid_from_filter_for_invitations.any? %>
                    <%= link_to platform_platform_invitations_path(@platform, 
                          filters: { 
                            search: current_search_filter_for_invitations,
                            status: current_status_filter_for_invitations,
                            valid_until: current_valid_until_filter_for_invitations,
                            accepted_at: current_accepted_at_filter_for_invitations,
                            last_sent: current_last_sent_filter_for_invitations
                          }.compact_blank,
                          sort_by: params[:sort_by],
                          sort_direction: params[:sort_direction],
                          page: params[:page]
                        ), class: 'btn btn-outline-secondary btn-sm', 
                        title: t('globals.clear_filter'),
                        'aria-label' => t('globals.clear_filter'),
                        data: { turbo_frame: "platform_invitations_content" } do %>
                      <i class="fas fa-times" aria-hidden="true"></i>
                    <% end %>
                  <% end %>
                </div>
              </th>
              <!-- Valid until column - datetime filter -->
              <th>
                <div class="d-flex flex-column gap-1">
                  <div class="input-group input-group-sm">
                    <%= form.date_field 'filters[valid_until][from]', 
                        value: current_valid_until_filter_for_invitations[:from],
                        class: 'form-control form-control-sm',
                        placeholder: t('globals.from'),
                        'aria-label' => "#{BetterTogether::PlatformInvitation.human_attribute_name(:valid_until)} #{t('globals.from')}" %>
                  </div>
                  <div class="input-group input-group-sm">
                    <%= form.date_field 'filters[valid_until][to]', 
                        value: current_valid_until_filter_for_invitations[:to],
                        class: 'form-control form-control-sm',
                        placeholder: t('globals.to'),
                        'aria-label' => "#{BetterTogether::PlatformInvitation.human_attribute_name(:valid_until)} #{t('globals.to')}" %>
                  </div>
                  <% if current_valid_until_filter_for_invitations.any? %>
                    <%= link_to platform_platform_invitations_path(@platform, 
                          filters: { 
                            search: current_search_filter_for_invitations,
                            status: current_status_filter_for_invitations,
                            valid_from: current_valid_from_filter_for_invitations,
                            accepted_at: current_accepted_at_filter_for_invitations,
                            last_sent: current_last_sent_filter_for_invitations
                          }.compact_blank,
                          sort_by: params[:sort_by],
                          sort_direction: params[:sort_direction],
                          page: params[:page]
                        ), class: 'btn btn-outline-secondary btn-sm', 
                        title: t('globals.clear_filter'),
                        'aria-label' => t('globals.clear_filter'),
                        data: { turbo_frame: "platform_invitations_content" } do %>
                      <i class="fas fa-times" aria-hidden="true"></i>
                    <% end %>
                  <% end %>
                </div>
              </th>
              <!-- Accepted at column - datetime filter -->
              <th>
                <div class="d-flex flex-column gap-1">
                  <div class="input-group input-group-sm">
                    <%= form.date_field 'filters[accepted_at][from]', 
                        value: current_accepted_at_filter_for_invitations[:from],
                        class: 'form-control form-control-sm',
                        placeholder: t('globals.from'),
                        'aria-label' => "#{BetterTogether::PlatformInvitation.human_attribute_name(:accepted_at)} #{t('globals.from')}" %>
                  </div>
                  <div class="input-group input-group-sm">
                    <%= form.date_field 'filters[accepted_at][to]', 
                        value: current_accepted_at_filter_for_invitations[:to],
                        class: 'form-control form-control-sm',
                        placeholder: t('globals.to'),
                        'aria-label' => "#{BetterTogether::PlatformInvitation.human_attribute_name(:accepted_at)} #{t('globals.to')}" %>
                  </div>
                  <% if current_accepted_at_filter_for_invitations.any? %>
                    <%= link_to platform_platform_invitations_path(@platform, 
                          filters: { 
                            search: current_search_filter_for_invitations,
                            status: current_status_filter_for_invitations,
                            valid_from: current_valid_from_filter_for_invitations,
                            valid_until: current_valid_until_filter_for_invitations,
                            last_sent: current_last_sent_filter_for_invitations
                          }.compact_blank,
                          sort_by: params[:sort_by],
                          sort_direction: params[:sort_direction],
                          page: params[:page]
                        ), class: 'btn btn-outline-secondary btn-sm', 
                        title: t('globals.clear_filter'),
                        'aria-label' => t('globals.clear_filter'),
                        data: { turbo_frame: "platform_invitations_content" } do %>
                      <i class="fas fa-times" aria-hidden="true"></i>
                    <% end %>
                  <% end %>
                </div>
              </th>
              <!-- Last sent column - datetime filter -->
              <th>
                <div class="d-flex flex-column gap-1">
                  <div class="input-group input-group-sm">
                    <%= form.date_field 'filters[last_sent][from]', 
                        value: current_last_sent_filter_for_invitations[:from],
                        class: 'form-control form-control-sm',
                        placeholder: t('globals.from'),
                        'aria-label' => "#{BetterTogether::PlatformInvitation.human_attribute_name(:last_sent)} #{t('globals.from')}" %>
                  </div>
                  <div class="input-group input-group-sm">
                    <%= form.date_field 'filters[last_sent][to]', 
                        value: current_last_sent_filter_for_invitations[:to],
                        class: 'form-control form-control-sm',
                        placeholder: t('globals.to'),
                        'aria-label' => "#{BetterTogether::PlatformInvitation.human_attribute_name(:last_sent)} #{t('globals.to')}" %>
                  </div>
                  <% if current_last_sent_filter_for_invitations.any? %>
                    <%= link_to platform_platform_invitations_path(@platform, 
                          filters: { 
                            search: current_search_filter_for_invitations,
                            status: current_status_filter_for_invitations,
                            valid_from: current_valid_from_filter_for_invitations,
                            valid_until: current_valid_until_filter_for_invitations,
                            accepted_at: current_accepted_at_filter_for_invitations
                          }.compact_blank,
                          sort_by: params[:sort_by],
                          sort_direction: params[:sort_direction],
                          page: params[:page]
                        ), class: 'btn btn-outline-secondary btn-sm', 
                        title: t('globals.clear_filter'),
                        'aria-label' => t('globals.clear_filter'),
                        data: { turbo_frame: "platform_invitations_content" } do %>
                      <i class="fas fa-times" aria-hidden="true"></i>
                    <% end %>
                  <% end %>
                </div>
              </th>
              <!-- Created at column - no filter -->
              <th></th>
            </tr>
          </thead>

          <tbody id="platform_invitations_table_body">
            <%= (render partial: 'better_together/platform_invitations/platform_invitation', collection: @platform_invitations) || (render partial: 'better_together/platform_invitations/empty') %>
          </tbody>
          </table>
          
          <!-- Hidden fields to preserve all filter and pagination parameters -->
          <%= render partial: 'better_together/platform_invitations/filter_hidden_fields', locals: { form: form, exclude: [] } %>
        <% end %>
      <% end %>
    </div>
  </div>

  <!-- Pagination -->
  <% if @platform_invitations.respond_to?(:current_page) %>
    <div class="row mt-3">
      <div class="col-md-6">
        <p class="text-muted">
          <%= t('globals.pagination.showing') %>
          <%= @platform_invitations.offset_value + 1 %> 
          <%= t('globals.pagination.to') %>
          <%= [@platform_invitations.offset_value + @platform_invitations.limit_value, @platform_invitations.total_count].min %>
          <%= t('globals.pagination.of') %>
          <%= @platform_invitations.total_count %>
          <%= t('better_together.platform_invitations.invitations').downcase %>
        </p>
      </div>
      <div class="col-md-6">
        <div class="d-flex justify-content-end">
                    <%= paginate @platform_invitations, 
                       remote: true,
                       data: { turbo_frame: "platform_invitations_content" } %>
        </div>
      </div>
    </div>
  <% end %>
<% end %>

<script type="text/javascript">
  // Define a function to replace 'better-together' with 'better_together'
  function replaceBetterTogetherAttributes() {
    // Select all elements with data attributes starting with 'data-better-together--'
    const elements = document.querySelectorAll('[data-better-together--platform-invitations-target]');

    elements.forEach(element => {
      // Loop through all attributes of each element
      Array.from(element.attributes).forEach(attr => {
        if (attr.name.startsWith('data-better-together--')) {
          // Generate the new attribute name by replacing 'better-together' with 'better_together'
          const newAttrName = attr.name.replace(/better-together/g, 'better_together');

          // Set the new attribute with the same value
          element.setAttribute(newAttrName, attr.value);

          // Optionally remove the old attribute if needed
          element.removeAttribute(attr.name);
        }
      });
    });
  }

  // Ensure the function runs on both DOMContentLoaded and turbo:load
  function initializeAttributeReplacement() {
    replaceBetterTogetherAttributes();
  }

  document.addEventListener('DOMContentLoaded', initializeAttributeReplacement);
  document.addEventListener('turbo:load', initializeAttributeReplacement);
</script>