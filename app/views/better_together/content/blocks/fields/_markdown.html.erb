<%# frozen_string_literal: true %>
<%# locals: (block:, scope: BetterTogether::Content::Block.block_name, temp_id: SecureRandom.uuid) -%>

<% inline_radio_id = "#{temp_id}_markdown_source_inline" %>
<% file_radio_id = "#{temp_id}_markdown_source_file" %>
<% inline_selected = block.markdown_file_path.blank? %>

<div class="markdown-fields"
     data-controller="better-together--markdown-block better-together--dependent-fields">
  <!-- Radio buttons to choose between source or file -->
  <div class="mb-3">
    <%= label_tag nil, 'Markdown Source', class: 'form-label' %>
    <div class="form-check">
      <%= radio_button_tag "#{scope}[markdown_source_type]", 'inline', inline_selected,
          class: 'form-check-input', 
          id: inline_radio_id,
          data: { 
            action: 'change->better-together--markdown-block#handleSourceTypeChange',
            'better-together--markdown-block-target': 'sourceTypeRadio',
            'better-together--dependent-fields-target': 'controlField'
          } %>
      <%= label_tag inline_radio_id, 'Write Markdown Inline', class: 'form-check-label' %>
    </div>
    <div class="form-check">
      <%= radio_button_tag "#{scope}[markdown_source_type]", 'file', block.markdown_file_path.present?, 
          class: 'form-check-input', 
          id: file_radio_id,
          data: { 
            action: 'change->better-together--markdown-block#handleSourceTypeChange',
            'better-together--markdown-block-target': 'sourceTypeRadio',
            'better-together--dependent-fields-target': 'controlField'
          } %>
      <%= label_tag file_radio_id, 'Reference a Markdown File', class: 'form-check-label' %>
    </div>
  </div>

  <!-- Inline markdown source textarea -->
  <div class="mb-3 markdown-inline-field <%= 'hidden-field' unless inline_selected %>"
       data-better-together--markdown-block-target="inlineField"
       data-better-together--dependent-fields-target="dependentField"
       data-dependent-fields-control="<%= inline_radio_id %>"
       data-show-if-control_<%= inline_radio_id %>="inline">
    <%= label_tag "#{scope}[markdown_source]", 'Markdown Content', class: 'form-label' %>
    <%= text_area_tag "#{scope}[markdown_source]", 
        block.markdown_source, 
        class: "form-control font-monospace#{' is-invalid' if block.errors[:markdown_source].any?}", 
        rows: 12,
        placeholder: "# Your Markdown Here\n\nWrite your markdown content...",
        data: { 'better-together--markdown-block-target': 'sourceTextarea' },
        disabled: !inline_selected %>
    
    <% if block.errors[:markdown_source].any? %>
      <div class="invalid-feedback">
        <%= block.errors[:markdown_source].join(", ") %>
      </div>
    <% end %>
    
    <small class="form-text text-muted mt-2">
      Write your markdown content directly. Supports GitHub-flavored markdown including tables, code blocks, and more.
    </small>
  </div>

  <!-- File path field -->
  <div class="mb-3 markdown-file-field <%= 'hidden-field' if inline_selected %>"
       data-better-together--markdown-block-target="fileField"
       data-better-together--dependent-fields-target="dependentField"
       data-dependent-fields-control="<%= file_radio_id %>"
       data-show-if-control_<%= file_radio_id %>="file">
    <%= label_tag "#{scope}[markdown_file_path]", 'Markdown File Path', class: 'form-label' %>
    <%= text_field_tag "#{scope}[markdown_file_path]", 
        block.markdown_file_path, 
        class: "form-control font-monospace#{' is-invalid' if block.errors[:markdown_file_path].any?}", 
        placeholder: "docs/README.md or /absolute/path/to/file.md",
        data: { 'better-together--markdown-block-target': 'filePathInput' },
        disabled: inline_selected %>
    
    <% if block.errors[:markdown_file_path].any? %>
      <div class="invalid-feedback">
        <%= block.errors[:markdown_file_path].join(", ") %>
      </div>
    <% end %>
    
    <small class="form-text text-muted mt-2">
      Path to a markdown file. Can be relative to Rails.root (e.g., <code>docs/README.md</code>) or absolute (e.g., <code>/path/to/file.md</code>). File must have a .md or .markdown extension.
    </small>
  </div>

  <!-- Preview area -->
  <div class="mb-3">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <%= label_tag nil, 'Preview', class: 'form-label mb-0' %>
      <button type="button" 
              class="btn btn-sm btn-outline-secondary"
              data-action="click->better-together--markdown-block#refreshPreview">
        <i class="fa fa-refresh"></i> Refresh Preview
      </button>
    </div>
    <div class="border rounded p-3 bg-light markdown-content" 
         data-better-together--markdown-block-target="preview"
         style="min-height: 200px;">
      <% if block.content.present? %>
        <%= block.rendered_html %>
      <% else %>
        <p class="text-muted mb-0">
          <em>Preview will appear here...</em>
        </p>
      <% end %>
    </div>
  </div>
</div>
