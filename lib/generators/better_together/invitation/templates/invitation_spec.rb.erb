# frozen_string_literal: true

require 'rails_helper'

RSpec.describe BetterTogether::<%= invitation_name.classify %>Invitation do
  describe 'Factory' do
    subject(:<%= invitation_name %>_invitation) { create(:better_together_<%= invitation_name %>_invitation) }

    it 'has a valid factory' do
      expect(<%= invitation_name %>_invitation).to be_valid
    end
  end

  describe 'ActiveRecord associations' do
    it { is_expected.to belong_to(:invitable).required }
    it { is_expected.to belong_to(:inviter).required }
    it { is_expected.to belong_to(:invitee).optional }
    it { is_expected.to belong_to(:role).optional }
  end

  describe 'Validations' do
    it { is_expected.to validate_inclusion_of(:locale).in_array(I18n.available_locales.map(&:to_s)) }
    it { is_expected.to validate_presence_of(:locale) }

    describe 'invitee presence validation' do
      context 'when both invitee and invitee_email are blank' do
        it 'requires either invitee or invitee_email' do
          invitation = build(:better_together_<%= invitation_name %>_invitation, invitee: nil, invitee_email: '')
          expect(invitation).not_to be_valid
          expect(invitation.errors[:base]).to include('must have either an invitee or invitee email')
        end
      end
    end

    describe 'invitee uniqueness for <%= invitation_name %>' do
      let(:<%= invitation_name %>) { create(:better_together_<%= invitation_name %>) }

      it 'prevents duplicate invitations to the same <%= invitation_name %>' do
        invitation = create(:better_together_<%= invitation_name %>_invitation, invitable: <%= invitation_name %>)
        duplicate = build(:better_together_<%= invitation_name %>_invitation, 
                          invitable: <%= invitation_name %>, 
                          invitee_email: invitation.invitee_email)
        
        expect(duplicate).not_to be_valid
        expect(duplicate.errors[:invitee_email]).to include('has already been taken')
      end
    end
  end

  describe '#<%= invitation_name %>' do
    it 'returns the invitable <%= invitation_name %>' do
      <%= invitation_name %>_invitation = create(:better_together_<%= invitation_name %>_invitation)
      expect(<%= invitation_name %>_invitation.<%= invitation_name %>).to eq(<%= invitation_name %>_invitation.invitable)
    end
  end

  describe '#after_accept!' do
    let(:<%= invitation_name %>_invitation) { create(:better_together_<%= invitation_name %>_invitation, :with_invitee) }
    let(:person) { <%= invitation_name %>_invitation.invitee }

    it 'completes the invitation acceptance process' do
      # TODO: Add specific expectations for your <%= invitation_name %> acceptance logic
      # For example:
      # expect { <%= invitation_name %>_invitation.after_accept!(invitee_person: person) }
      #   .to change { <%= invitation_name %>_invitation.<%= invitation_name %>.<%= invitation_name %>_memberships.count }.by(1)
      
      expect { <%= invitation_name %>_invitation.after_accept!(invitee_person: person) }.not_to raise_error
    end
  end

  describe '#url_for_review' do
    it 'returns the review URL for the invitation' do
      <%= invitation_name %>_invitation = create(:better_together_<%= invitation_name %>_invitation)
      expected_url = BetterTogether::Engine.routes.url_helpers.<%= invitation_name %>_url(
        <%= invitation_name %>_invitation.invitable.slug,
        locale: <%= invitation_name %>_invitation.locale,
        invitation_token: <%= invitation_name %>_invitation.token
      )
      
      expect(<%= invitation_name %>_invitation.url_for_review).to eq(expected_url)
    end
  end

  describe '#decline!' do
    it 'changes status to declined' do
      <%= invitation_name %>_invitation = create(:better_together_<%= invitation_name %>_invitation)
      expect { <%= invitation_name %>_invitation.decline! }.to change { <%= invitation_name %>_invitation.reload.status }.to('declined')
    end
  end
end