#!/usr/bin/env bash
set -euo pipefail

WIDTH=${WIDTH:-1600}
HEIGHT=${HEIGHT:-1200}
OUT_FORMAT=${OUT_FORMAT:-png}

if command -v mmdc >/dev/null 2>&1; then
  RENDERER=(mmdc)
elif command -v npx >/dev/null 2>&1; then
  RENDERER=(npx -y @mermaid-js/mermaid-cli)
else
  echo "Error: Neither mermaid-cli (mmdc) nor npx is available in PATH." >&2
  echo "Install mermaid-cli or run: npx -y @mermaid-js/mermaid-cli ..." >&2
  exit 1
fi

shopt -s nullglob
files=(docs/*.mmd)
if [ ${#files[@]} -eq 0 ]; then
  echo "No Mermaid files found in docs/*.mmd" >&2
  exit 0
fi

failed=0
failed_files=()
for f in "${files[@]}"; do
  out="${f%.*}.${OUT_FORMAT}"
  echo "Rendering $f -> $out"
  if ! "${RENDERER[@]}" -i "$f" -o "$out" -w "$WIDTH" -H "$HEIGHT"; then
    echo "WARN: Failed to render $f; continuing with next file." >&2
    failed=1
    failed_files+=("$f")
  fi
done

echo "Done. Attempted ${#files[@]} diagram(s)."

if [ "$failed" -ne 0 ]; then
  echo "One or more diagrams failed to render. Please check the .mmd syntax and try again." >&2
  printf "Failed files:\n" >&2
  for ff in "${failed_files[@]}"; do
    printf " - %s\n" "$ff" >&2
  done
  exit 1
fi
